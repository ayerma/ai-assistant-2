name: Jira -> BA Assistant

on:
  workflow_dispatch:
    inputs:
      ticket_id:
        description: "Jira issue key (e.g., PROJ-123)"
        required: true
        type: string
      ticket_summary:
        description: "Jira issue summary (optional, will fetch if not provided)"
        required: false
        type: string
      ticket_description:
        description: "Jira issue description (optional, will fetch if not provided)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  run-ba-assistant:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Build
        run: mvn -q -DskipTests package

      - name: Install GitHub Copilot CLI
        if: ${{ vars.USE_MODELS_API != 'true' && vars.USE_MODELS_API != '' }}
        run: |
          set +e  # Don't exit on errors during verification
          echo "=== Installing GitHub Copilot CLI ==="
          echo "USE_MODELS_API value: '${{ vars.USE_MODELS_API }}'"

          # Install Copilot CLI
          npm install -g @github/copilot

          # Show npm global bin path and add to GITHUB_PATH (persists across steps)
          NPM_PREFIX=$(npm prefix -g)
          NPM_BIN="$NPM_PREFIX/bin"
          echo "npm global prefix: $NPM_PREFIX"
          echo "npm global bin: $NPM_BIN"
          echo "$NPM_BIN" >> $GITHUB_PATH

          # List installed global packages
          echo "=== Installed npm global packages ==="
          npm list -g --depth=0

          # Show ALL files in npm bin directory
          echo "=== All files in npm bin ==="
          ls -la $NPM_BIN

          # Check for available copilot-related commands
          echo "=== Looking for copilot commands ==="
          ls -la $NPM_BIN | grep -i copilot || echo "No copilot commands found"

          # Try different possible command names
          echo "=== Testing possible command names ==="
          for cmd in copilot github-copilot github-copilot-cli ghcs; do
            if [ -f "$NPM_BIN/$cmd" ]; then
              echo "Found: $cmd"
              $NPM_BIN/$cmd --version 2>&1 || echo "$cmd --version failed"
            fi
          done

          echo "=== Install step complete ==="

      - name: Authenticate Copilot CLI
        if: ${{ vars.USE_MODELS_API != 'true' && vars.USE_MODELS_API != '' }}
        run: |
          echo "=== Authenticating GitHub Copilot CLI ==="
          if [ -z "${{ secrets.COPILOT_GITHUB_TOKEN }}" ]; then
            echo "ERROR: COPILOT_GITHUB_TOKEN secret is not set!"
            exit 1
          else
            echo "COPILOT_GITHUB_TOKEN is set (length: ${#COPILOT_GITHUB_TOKEN} chars)"
          fi
          echo "${{ secrets.COPILOT_GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Run BA assistant
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

          USE_MODELS_API: ${{ vars.USE_MODELS_API || 'true' }}

          # GitHub Models API configuration (when USE_MODELS_API=true)
          MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
          MODELS_ENDPOINT: ${{ vars.MODELS_ENDPOINT }}
          MODELS_MODEL: ${{ vars.MODELS_MODEL }}

          BA_INSTRUCTIONS_PATH: instructions/platform/roles/ba-role.md
          TECHNICAL_REQUIREMENTS_PATH: instructions/platform/technical/technical-requirements.md
          BA_OUTPUT_PATH: ba-output.json

          JIRA_ISSUE_KEY: ${{ inputs.ticket_id }}
          JIRA_ISSUE_SUMMARY: ${{ inputs.ticket_summary }}
          JIRA_ISSUE_DESCRIPTION: ${{ inputs.ticket_description }}

          # For CLI mode: generate prompt only, then call copilot from workflow
          OUTPUT_PROMPT_ONLY: ${{ vars.USE_MODELS_API != 'true' && vars.USE_MODELS_API != '' }}
          PROMPT_OUTPUT_PATH: ba-prompt.txt

          # Copilot CLI authentication (for CLI mode)
          GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
        run: |
          if [ "$USE_MODELS_API" = "true" ]; then
            echo "=== Using GitHub Models API directly from Java ==="
            java -jar target/ai-assistant-2-automation-0.1.0-all.jar
          else
            echo "=== Generating prompt for Copilot CLI ==="
            java -jar target/ai-assistant-2-automation-0.1.0-all.jar
            
            echo "=== Calling Copilot CLI from workflow ==="
            copilot --allow-all-tools -p "$(cat ba-prompt.txt)" > ba-output-raw.txt
            
            echo "=== Extracting JSON from Copilot output ==="
            # Extract JSON block from copilot output (may contain extra text)
            python3 -c "
          import re
          import json

          with open('ba-output-raw.txt', 'r') as f:
              content = f.read()

          # Try to find JSON block
          json_match = re.search(r'\{.*\}', content, re.DOTALL)
          if json_match:
              json_str = json_match.group(0)
              parsed = json.loads(json_str)
              with open('ba-output.json', 'w') as out:
                  json.dump(parsed, out, indent=2)
              print('[SUCCESS] Extracted and wrote JSON output')
          else:
              print('[ERROR] No JSON found in copilot output')
              exit(1)
          "
          fi

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: ba-output
          path: ba-output.json
